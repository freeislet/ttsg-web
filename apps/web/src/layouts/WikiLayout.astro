---
import Layout from './Layout.astro'
import Header from '@/components/Header.astro'
import Footer from '@/components/Footer.astro'
import TableOfContents from '@/components/blog/TableOfContents.astro'
import { WikiLinkProcessor } from '@/components/blog/WikiLinkProcessor'
import '@/styles/blog.css'

export interface Props {
  title: string
  description?: string
  content: string
  headings?: any[]
  tags?: string[]
  createdDate?: Date
  updatedDate?: Date
  availableVersions?: string[]
  availableLanguages?: string[]
  currentVersion?: string
  currentLanguage?: string
}

const {
  title,
  description,
  content,
  headings = [],
  tags = [],
  createdDate,
  updatedDate,
  availableVersions = [],
  availableLanguages = [],
  currentVersion,
  currentLanguage = 'ko',
} = Astro.props

// SEOë¥¼ ìœ„í•œ ë©”íƒ€ ì •ë³´ êµ¬ì„±
const seo = {
  title: `${title} | TTSG Wiki`,
  description: description || `${title}ì— ëŒ€í•œ ìœ„í‚¤ í˜ì´ì§€ì…ë‹ˆë‹¤.`,
  url: `/wiki/${Astro.params.slug}`,
  type: 'article' as const,
  keywords: [...tags, 'TTSG', 'ìœ„í‚¤', 'Wiki'],
}
---

<Layout seo={seo}>
  <Header />

  <main class="min-h-screen bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 py-8">
      <div class="flex flex-col lg:flex-row gap-8">
        <!-- ë©”ì¸ ì½˜í…ì¸  -->
        <article class="flex-1 max-w-4xl">
          <!-- ìœ„í‚¤ í—¤ë” -->
          <header class="mb-8">
            <div class="space-y-4">
              <!-- ìœ„í‚¤ ë°°ì§€ -->
              <div class="flex items-center gap-2">
                <span
                  class="inline-block px-3 py-1 text-sm font-medium rounded-full bg-blue-100 text-blue-800"
                >
                  ğŸ“– Wiki
                </span>
              </div>

              <!-- ì œëª© -->
              <h1 class="text-3xl md:text-4xl font-bold text-gray-900 leading-tight">
                {title}
              </h1>

              <!-- ë©”íƒ€ ì •ë³´ -->
              <div class="flex flex-wrap items-center gap-4 text-sm text-gray-600">
                {
                  createdDate && (
                    <span class="flex items-center gap-1">
                      ğŸ“… ìƒì„±: {createdDate.toLocaleDateString('ko-KR')}
                    </span>
                  )
                }

                {
                  updatedDate && (
                    <span class="flex items-center gap-1">
                      âœï¸ ìˆ˜ì •: {updatedDate.toLocaleDateString('ko-KR')}
                    </span>
                  )
                }

                {
                  tags.length > 0 && (
                    <div class="flex flex-wrap gap-2">
                      {tags.map((tag: string) => (
                        <span class="inline-block px-2 py-1 text-xs font-medium bg-gray-200 text-gray-700 rounded-md">
                          #{tag}
                        </span>
                      ))}
                    </div>
                  )
                }
              </div>

              <!-- ì„¤ëª… -->
              {description && <p class="text-lg text-gray-600 leading-relaxed">{description}</p>}

              <!-- ë²„ì „ ë° ì–¸ì–´ ì„ íƒ -->
              {
                (availableVersions.length > 0 || availableLanguages.length > 1) && (
                  <div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                    <div class="flex flex-wrap gap-4 items-center">
                      {availableVersions.length > 0 && (
                        <div class="flex items-center gap-2">
                          <label class="text-sm font-medium text-blue-800">ë²„ì „:</label>
                          <select
                            id="version-select"
                            class="px-3 py-1 text-sm border border-blue-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                            onchange="updateWikiVersion(this.value)"
                          >
                            <option value="">ê¸°ë³¸</option>
                            {availableVersions.map((version) => (
                              <option value={version} selected={version === currentVersion}>
                                {version}
                              </option>
                            ))}
                          </select>
                        </div>
                      )}

                      {availableLanguages.length > 1 && (
                        <div class="flex items-center gap-2">
                          <label class="text-sm font-medium text-blue-800">ì–¸ì–´:</label>
                          <select
                            id="language-select"
                            class="px-3 py-1 text-sm border border-blue-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                            onchange="updateWikiLanguage(this.value)"
                          >
                            {availableLanguages.map((language) => (
                              <option value={language} selected={language === currentLanguage}>
                                {language === 'ko'
                                  ? 'í•œêµ­ì–´'
                                  : language === 'en'
                                    ? 'English'
                                    : language}
                              </option>
                            ))}
                          </select>
                        </div>
                      )}
                    </div>
                  </div>
                )
              }
            </div>
          </header>

          <!-- ëª¨ë°”ì¼ ëª©ì°¨ -->
          {
            headings.length > 0 && (
              <div class="lg:hidden">
                <TableOfContents headings={headings} isMobile={true} />
              </div>
            )
          }

          <!-- ìœ„í‚¤ ì½˜í…ì¸  -->
          <div class="prose prose-lg prose-gray max-w-none mx-auto blog-content">
            <div class="bg-white rounded-lg shadow-sm p-6 md:p-8">
              <div set:html={content} />
            </div>
          </div>

          <!-- WikiLink í”„ë¡œì„¸ì„œ -->
          <WikiLinkProcessor client:load />

          <!-- ìœ„í‚¤ í‘¸í„° -->
          <footer class="mt-12 pt-8 border-t border-gray-200">
            <div class="flex items-center justify-between">
              <div class="text-sm text-gray-500">
                ì´ ìœ„í‚¤ í˜ì´ì§€ê°€ ë„ì›€ì´ ë˜ì…¨ë‚˜ìš”? TTSGì—ì„œ ë” ë§ì€ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.
              </div>
            </div>
          </footer>
        </article>

        <!-- ë°ìŠ¤í¬í†± ì‚¬ì´ë“œë°” ëª©ì°¨ -->
        {
          headings.length > 0 && (
            <aside class="hidden lg:block w-64 flex-shrink-0">
              <TableOfContents headings={headings} isMobile={false} />
            </aside>
          )
        }
      </div>
    </div>
  </main>

  <Footer />

  <!-- ë²„ì „/ì–¸ì–´ ë³€ê²½ì„ ìœ„í•œ JavaScript -->
  <script>
    function updateWikiVersion(version: string) {
      const url = new URL(window.location.href)
      if (version) {
        url.searchParams.set('version', version)
      } else {
        url.searchParams.delete('version')
      }
      window.location.href = url.toString()
    }

    function updateWikiLanguage(language: string) {
      const url = new URL(window.location.href)
      url.searchParams.set('language', language)
      window.location.href = url.toString()
    }

    // ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡
    ;(window as any).updateWikiVersion = updateWikiVersion
    ;(window as any).updateWikiLanguage = updateWikiLanguage
  </script>
</Layout>
