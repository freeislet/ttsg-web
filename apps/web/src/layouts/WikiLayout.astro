---
import Layout from './Layout.astro'
import Header from '@/components/Header.astro'
import Footer from '@/components/Footer.astro'
import TableOfContents from '@/components/blog/TableOfContents.astro'
import { WikiLinkProcessor } from '@/components/blog/WikiLinkProcessor'
import VersionLanguageSelector from '@/components/wiki/VersionLanguageSelector'
import type { NotionPage } from '@/client/wiki'
import '@/styles/markdown.css'

export interface Props {
  title: string
  description?: string
  content: string
  headings?: any[]
  tags?: string[]
  createdDate?: Date
  updatedDate?: Date
  notionUrl?: string
  pages?: NotionPage[]
  selectedPageId?: string
}

const {
  title,
  description,
  content,
  headings = [],
  tags = [],
  createdDate,
  updatedDate,
  notionUrl,
  pages = [],
  selectedPageId,
} = Astro.props

// SEO를 위한 메타 정보 구성
const seo = {
  title: `${title} | TTSG Wiki`,
  description: description || `${title}에 대한 위키 페이지입니다.`,
  url: `/wiki/${Astro.params.slug}`,
  type: 'article' as const,
  keywords: [...tags, 'TTSG', '위키', 'Wiki'],
}
---

<Layout seo={seo}>
  <Header />

  <main class="min-h-screen bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 py-8">
      <div class="flex flex-col lg:flex-row gap-8">
        <!-- 메인 콘텐츠 -->
        <article class="flex-1 max-w-4xl">
          <!-- 위키 헤더 -->
          <header class="mb-8">
            <div class="space-y-4">
              <!-- 위키 배지 -->
              <div class="flex items-center gap-2">
                <span
                  class="inline-block px-3 py-1 text-sm font-medium rounded-full bg-blue-100 text-blue-800"
                >
                  📖 Wiki
                </span>
              </div>

              <!-- 제목 -->
              <h1 class="text-3xl md:text-4xl font-bold text-gray-900 leading-tight">
                {title}
              </h1>

              <!-- 메타 정보 -->
              <div class="flex flex-wrap items-center gap-4 text-sm text-gray-600">
                {
                  createdDate && (
                    <span class="flex items-center gap-1">
                      📅 생성: {createdDate.toLocaleDateString('ko-KR')}
                    </span>
                  )
                }

                {
                  updatedDate && (
                    <span class="flex items-center gap-1">
                      ✏️ 수정: {updatedDate.toLocaleDateString('ko-KR')}
                    </span>
                  )
                }

                {
                  tags.length > 0 && (
                    <div class="flex flex-wrap gap-2">
                      {tags.map((tag: string) => (
                        <span class="inline-block px-2 py-1 text-xs font-medium bg-gray-200 text-gray-700 rounded-md">
                          #{tag}
                        </span>
                      ))}
                    </div>
                  )
                }
              </div>

              <!-- 설명 -->
              {description && <p class="text-lg text-gray-600 leading-relaxed">{description}</p>}

              <!-- 버전 및 언어 선택 -->
              <VersionLanguageSelector client:load pages={pages} selectedPageId={selectedPageId} />
            </div>
          </header>

          <!-- 모바일 목차 -->
          {
            headings.length > 0 && (
              <div class="lg:hidden">
                <TableOfContents headings={headings} isMobile={true} />
              </div>
            )
          }

          <!-- 위키/블로그 공용 마크다운 콘텐츠 -->
          <div class="prose prose-lg prose-gray max-w-none mx-auto md-content">
            <div class="bg-white rounded-lg shadow-sm p-6 md:p-8">
              <div set:html={content} />
            </div>
          </div>

          <!-- WikiLink 프로세서 -->
          <WikiLinkProcessor client:load />

          <!-- 위키 푸터 -->
          <footer class="mt-12 pt-8 border-t border-gray-200">
            <div class="flex items-center justify-between">
              <div class="text-sm text-gray-500">
                이 위키 페이지가 도움이 되셨나요? TTSG에서 더 많은 정보를 확인하세요.
              </div>

              {
                notionUrl && (
                  <a
                    href={notionUrl}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors"
                  >
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M4.459 4.208c.746.606 1.026.56 2.428.466l13.215-.793c.28 0 .047-.28-.046-.326L17.86 1.968c-.42-.326-.981-.7-2.055-.607L3.01 2.295c-.466.046-.56.28-.374.466zm.793 3.08v13.904c0 .747.373 1.027 1.214.98l14.523-.84c.841-.046.935-.56.935-1.167V6.354c0-.606-.233-.933-.748-.887l-15.177.887c-.56.047-.747.327-.747.933zm14.337.745c.093.42 0 .84-.42.888l-.7.14v10.264c-.608.327-1.168.514-1.635.514-.748 0-.935-.234-1.495-.933l-4.577-7.186v6.952L12.21 19s0 .84-1.168.84l-3.222.186c-.093-.186 0-.653.327-.746l.84-.233V9.854L7.822 9.76c-.094-.42.14-1.026.793-1.073l3.456-.233 4.764 7.279v-6.44l-1.215-.139c-.093-.514.28-.887.747-.933zM1.936 1.035l13.31-.98c1.634-.14 2.055-.047 3.082.7l4.249 2.986c.7.513.934.747.934 1.213v16.378c0 1.026-.373 1.634-1.68 1.726l-15.458.934c-.934.047-1.401-.14-1.868-.793l-3.129-4.06c-.56-.747-.793-1.306-.793-1.96V2.667c0-.839.374-1.54 1.353-1.632z" />
                    </svg>
                    노션에서 보기
                  </a>
                )
              }
            </div>
          </footer>
        </article>

        <!-- 데스크톱 사이드바 목차 -->
        {
          headings.length > 0 && (
            <aside class="hidden lg:block w-64 flex-shrink-0">
              <TableOfContents headings={headings} isMobile={false} />
            </aside>
          )
        }
      </div>
    </div>
  </main>

  <Footer />
</Layout>
